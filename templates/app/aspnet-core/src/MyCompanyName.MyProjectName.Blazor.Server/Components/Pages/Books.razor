@page "/books"

@using Volo.Abp.MultiTenancy
@inject PersistentComponentState ApplicationState
@inject ICurrentTenant CurrentTenant

<p role="status">Current count: @currentCount</p>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>

<p>Hello by @Token</p>

@code {

    private int currentCount;

    private string? Token { get; set; } = default!;


    protected override async Task OnInitializedAsync()
    {
        ApplicationState.RegisterOnPersisting(OnPersistingAsync, RenderMode.InteractiveServer);
        ApplicationState.RegisterOnPersisting(PersistCount);

        if (ApplicationState.TryTakeFromJson<string> ("name", out var restored))
        {
            Token = $"Token is restored: {restored}";
        }
        else
        {
            Token = "Token is not restored";
        }

        if (!ApplicationState.TryTakeFromJson<int>(nameof(currentCount), out var restoredCount))
        {
            currentCount = Random.Shared.Next(100);
        }
        else
        {
            currentCount = restoredCount!;
        }
    }

    private Task PersistCount()
    {
        ApplicationState.PersistAsJson(nameof(currentCount), currentCount);

        return Task.CompletedTask;
    }


    private void IncrementCount() => currentCount++;

    async Task OnPersistingAsync()
    {
        ApplicationState.PersistAsJson("name", "hemant");

        await Task.CompletedTask;
    }

}
